# Model Thumbnail System Documentation

## 1. Overview

This document provides a comprehensive guide to the GLB/GLTF model thumbnail generation system within `cpc-studio`. The system is designed to automatically create high-quality, performant thumbnails for 3D models, which are used throughout the editor's UI, particularly in the Asset Browser.

This documentation covers:
- The system's architecture and how it integrates with Bevy.
- Detailed testing procedures for ensuring correctness and performance.
- Quality and performance verification metrics.
- Usage guidelines and FFI specifications for mobile (Android/iOS) implementations.

## 2. Architecture

The thumbnail generation process is a specific task handled by the `Asset Processor` component, as outlined in the main [Asset Management Architecture](./asset_management_architecture.md). The core idea is to leverage the Bevy engine's rendering capabilities to produce a visually accurate preview of a 3D model, which is then saved as a PNG image.

### 2.1. Architecture Diagram

```mermaid
graph TD
    subgraph "Asset Service"
        A[Asset Importer/Updater]
    end

    subgraph "Asset Processor"
        B[Thumbnail Generation Task]
    end

    subgraph "Bevy Headless Instance"
        C[Spawns a Scene]
        D[Renders to Framebuffer]
        E[Captures Image Buffer]
    end

    subgraph "Storage"
        F[Source GLB/GLTF File]
        G[Cache: .cache/thumbnails/{asset_id}.png]
        H[AssetMetadataStore]
    end

    A -- "Triggers for Model Asset" --> B
    B -- "Reads Model Path from Metadata" --> H
    B -- "Loads" --> F
    B -- "Commands Bevy to Render" --> C
    C -- "Loads Model" --> F
    C -- "Renders Scene" --> D
    D -- "GPU Renders" --> E
    E -- "Returns PNG Data" --> B
    B -- "Saves Thumbnail" --> G
    B -- "Updates thumbnail_path" --> H
```

### 2.2. Process Flow

1.  **Trigger**: The `Asset Service` triggers the `Thumbnail Generation Task` when a new `Model` asset is imported or an existing one is updated.
2.  **Bevy Instance**: The task utilizes a headless Bevy instance. This avoids rendering to a visible window and allows for background processing.
3.  **Scene Setup**: A temporary Bevy scene is created. This scene includes:
    *   The 3D model loaded from its asset path.
    *   A standard set of lights (e.g., one key light, one fill light, and ambient light) to ensure consistent and clear visuals.
    *   A camera positioned to frame the model appropriately. The camera should dynamically adjust its position to fit the bounds of the model.
4.  **Render-to-Texture**: Bevy renders this scene to an off-screen framebuffer (a texture in memory) instead of the main window.
5.  **Image Capture**: The raw image data is read back from the GPU's framebuffer into CPU-accessible memory.
6.  **PNG Encoding**: The image buffer is encoded into a standard PNG format.
7.  **Storage**: The resulting `.png` file is saved to a local cache directory: `[PROJECT_ROOT]/.cache/thumbnails/{asset_id}.png`. This path is **not** part of the synchronized project data, as thumbnails can be regenerated by any peer.
8.  **Metadata Update**: The `thumbnail_path` field in the asset's `AssetMetadata` is updated in the local `AssetMetadataStore` to point to the newly created thumbnail file. This change is a local-only update and is not broadcast over the P2P network.

## 3. Testing Procedures

Thorough testing is critical to ensure the thumbnail system is reliable and produces high-quality results.

### 3.1. Sample Files

Testing should be performed with a variety of GLB/GLTF models:
*   **Simple Model**: A basic shape with a single material (e.g., a cube or sphere).
*   **Complex Model**: A model with multiple meshes, complex materials, and detailed geometry.
*   **Animation Model**: A model that includes animations (the thumbnail should be of the bind pose or a specific frame).
*   **No-Material Model**: A model with geometry but no assigned materials to test default material handling.
*   **Varying Scales**: Models that are very large or very small by default to test camera framing logic.

### 3.2. Verification Steps

For each sample file, perform the following checks:

1.  **Import**: Import the model into `cpc-studio`.
2.  **Thumbnail Generation**: Verify that a PNG file is created in `.cache/thumbnails/` with the correct `asset_id` as its name.
3.  **UI Display**: Confirm the thumbnail appears correctly in the Asset Browser.
4.  **Visual Fidelity**:
    *   Does the thumbnail accurately represent the model's shape?
    *   Is the lighting adequate and not over/under-exposed?
    *   Is the model correctly framed and centered?
    *   Are materials and textures (if present) rendered correctly?
5.  **Re-generation**: Modify the source `.glb` file and re-import it. Verify that the thumbnail is regenerated and updated in the UI.
6.  **Error Handling**: Attempt to import a corrupted or invalid GLB file. Verify that the system fails gracefully, does not generate a thumbnail, and logs an appropriate error.

## 4. Quality and Performance Metrics

### 4.1. Quality Metrics

| Metric          | Target Specification                     | Description                                                                 |
|-----------------|------------------------------------------|-----------------------------------------------------------------------------|
| **Resolution**    | 256x256 pixels                           | A standard size that balances detail and storage space.                     |
| **Aspect Ratio**  | 1:1 (Square)                             | Ensures consistency in UI layouts. The camera should frame to fit.          |
| **File Format**   | PNG                                      | Permissive, lossless format suitable for UI elements.                       |
| **Visual Fidelity**| High                                     | Must be a clear, well-lit, and accurate representation of the source model. |

### 4.2. Performance Benchmarks

These benchmarks should be measured on a mid-range developer machine.

| Metric                  | Target Benchmark      | Description                                                                      |
|-------------------------|-----------------------|----------------------------------------------------------------------------------|
| **Generation Time**     | < 500ms per model | The time from triggering the task to saving the final PNG file.                  |
| **Memory Usage (Peak)** | < 256MB             | The peak additional memory consumed by the headless Bevy instance during the process. |
| **CPU Usage**           | Low-Medium            | The process should not block the main UI thread and should run in the background. |

## 5. FFI Interface for Mobile (Android/iOS)

To support thumbnail generation on mobile platforms, a clear Foreign Function Interface (FFI) must be defined in the shared Rust core. Mobile clients will be responsible for their own Bevy integration to generate thumbnails using this shared logic.

### 5.1. FFI Specification

The following Rust function should be exposed from `cpc-core` (or a dedicated shared library) to be called from Kotlin/Swift.

**Rust Function Signature:**

```rust
/// Generates a thumbnail for a 3D model using a headless Bevy instance.
///
/// # Arguments
/// * `model_path`: The absolute path to the GLB/GLTF file.
/// * `output_path`: The absolute path where the generated PNG thumbnail should be saved.
/// * `size`: The desired width and height of the thumbnail (e.g., 256).
///
/// # Returns
/// A Result indicating success or an error string with details of the failure.
#[no_mangle]
pub extern "C" fn generate_model_thumbnail(
    model_path: *const c_char,
    output_path: *const c_char,
    size: u32
) -> *const c_char; // Returns a C-string with an error message, or null on success.
```

*Note: A more robust implementation might return a structured error or use a callback system, but a simple error string is a good starting point.*

### 5.2. Mobile Implementation Guidelines

**Android (Kotlin) / iOS (Swift) Teams:**

*   **Input**: You will provide the absolute file path to the downloaded/stored `.glb` model and the desired output path for the thumbnail.
*   **Output**: The function will write a PNG file to the specified `output_path`. It will return `null` (or an empty string) on success.
*   **Error Handling**: If the function returns a non-null C-string, it indicates an error. Your code must handle this by:
    *   Logging the error message from the Rust layer.
    *   Ensuring no broken thumbnail file is left on disk.
    *   Displaying a default/placeholder icon in the UI for that asset.
*   **Performance**: The thumbnail generation should be executed on a background thread to avoid blocking the UI. The performance expectations are similar to the desktop benchmarks.
*   **Bevy Integration**: Each mobile platform will need to manage its own Beovy integration to fulfill the requirements of the `generate_model_thumbnail` function. This includes setting up the headless rendering context.