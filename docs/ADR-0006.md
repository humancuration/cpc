# ADR 0006: Concurrency Handling and Test Coverage Enhancement

## Status
Accepted

## Date
2025-08-03

## Context
As the CPC platform grows with more concurrent users and complex interactions, we need robust concurrency handling to ensure data consistency and prevent race conditions. This is particularly important for:
- Volunteer hour tracking and conversions
- Skill exchange transactions
- Wallet balance updates
- Achievement awarding

Without proper concurrency control, we risk data inconsistencies, incorrect balances, and inaccurate skill tracking when multiple operations modify shared resources simultaneously.

## Decision
We chose to implement a comprehensive concurrency handling strategy using the following components:

### 1. TransactionManager Trait
We created a standardized TransactionManager trait to abstract transaction handling across services. This was chosen over manual transaction management for:
- Consistent error handling
- Simplified testing with mocks
- Code reuse across services
- Clear separation of concerns

```rust
#[async_trait::async_trait]
pub trait TransactionManager: Send + Sync {
    async fn begin_transaction(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>>;
    // Other transaction methods...
}
```

### 2. EventBus Implementation
We implemented a mockable EventBus trait to enable cross-service communication during transactions:
- Decouples service dependencies
- Supports event-driven architecture
- Allows testing event propagation
- Ensures atomic operations across services

### 3. Testing Utilities
We developed reusable testing utilities:
- **CurrencyValidator**: Ensures consistent currency validation
- **LargeDatasetSeeder**: Generates test data for performance testing
- **ConcurrencyTestHelpers**: Simplifies writing concurrent test scenarios

### 4. Concurrency Control Patterns
We implemented several concurrency patterns:
- Optimistic locking for volunteer updates
- Database-level locking for financial transactions
- Mutex-based conflict simulation in tests

### 5. Test Coverage Strategy
We enhanced test coverage by:
- Documenting test scenarios in TEST_SCENARIOS.md
- Implementing concurrency tests for critical paths
- Creating performance tests with large datasets

## Consequences

### Positive Outcomes
- Improved data consistency for concurrent operations
- Standardized transaction handling across services
- Better test coverage for edge cases
- Easier identification of concurrency issues
- More reliable financial and volunteer operations

### Challenges
- Added complexity to service implementations
- Performance overhead from locking mechanisms
- Requires careful test scenario design
- Increased test execution time for concurrency tests

### Neutral
- New dependencies for testing utilities
- Additional documentation requirements

## Implementation Details

### Key Components
1. **TransactionManager Trait**
   - Location: `apps/api_server/src/test_utils/mod.rs`
   - Provides standardized transaction lifecycle methods

2. **EventBus Implementations**
   - Multiple implementations in `shared_packages/event_bus/`
   - Enables cross-service event propagation

3. **Concurrency Tests**
   - Location: `shared_packages/volunteer_core/src/volunteer_service_test.rs`
   - Specifically `test_concurrent_volunteer_updates()`

4. **Testing Utilities**
   - `CurrencyValidator` and `LargeDatasetSeeder`
   - Location: `apps/api_server/src/test_utils/mod.rs`

5. **Test Documentation**
   - Location: `docs/TEST_SCENARIOS.md`
   - Covers all critical concurrency scenarios

### Integration Points
- Volunteer service uses TransactionManager for hour tracking
- Wallet service uses locking for balance updates
- Skill exchange service uses optimistic locking for transactions
- All services use EventBus for cross-service notifications

## References
1. TransactionManager implementation:  
   `apps/api_server/src/test_utils/mod.rs`
2. Concurrency test example:  
   `shared_packages/volunteer_core/src/volunteer_service_test.rs`
3. Test scenarios documentation:  
   `docs/TEST_SCENARIOS.md`
4. EventBus implementations:  
   `shared_packages/event_bus/`

## Future Considerations
- Implement database advisory locks for PostgreSQL
- Add distributed transaction support
- Develop more sophisticated conflict resolution
- Integrate with p2panda network for distributed concurrency